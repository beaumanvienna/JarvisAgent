<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üß† JarvisAgent Dashboard</title>
  <style>
    body {
      font-family: monospace;
      background-color: #1e1e1e;
      color: #44a01c;
      padding: 1rem;
      overflow: hidden;
    }

    h2 {
      margin-top: 0;
    }

    #log {
      white-space: pre-wrap;
      border: 1px solid #44a01c;
      border-radius: 6px;
      padding: 0.5rem;
      height: 20vh;
      overflow-y: auto;
      background: #111;
      margin-bottom: 1rem;
    }

    #input {
      width: 70%;
      background: #222;
      color: #44a01c;
      border: 1px solid #44a01c;
      padding: 0.5rem;
      border-radius: 4px;
    }

    #sendBtn {
      background: #44a01c;
      color: #111;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    /* ---- Answers panel ---- */
    #answers {
      margin-top: 1rem;
      border: 1px solid #44a01c;
      border-radius: 6px;
      padding: 0.5rem;
      height: 35vh;
      overflow-y: auto;
      background: #111;
    }

    .answer-card {
      border: 1px solid #333;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #1a1a1a;
    }

    .answer-header {
      font-weight: bold;
      color: #fff;
      margin-bottom: 0.25rem;
    }

    .answer-body {
      white-space: pre-wrap;
      color: #d6f5c6;
    }

    /* ---- Session boxes ---- */
    .session-box {
      position: absolute;
      min-width: 240px;
      background: rgba(30, 30, 30, 0.9);
      border: 1px solid white;
      border-radius: 10px;
      padding: 10px;
      cursor: move;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      user-select: none;
      transition: box-shadow 0.2s ease;
    }

    .session-box:hover {
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
    }

    .session-header {
      font-weight: bold;
      margin-bottom: 6px;
      color: #fff;
    }

    .session-state {
      color: #44a01c;
      line-height: 1.4em;
    }

    .spinner {
      color: #e0c341;
      display: inline-block;
      margin-left: 6px;
    }
  </style>
</head>

<body>


  <h2 style="display:flex; justify-content:space-between; align-items:center;">
    <span>üß† JarvisAgent Dashboard</span>
    <button id="quitBtn" style="background:#c33; color:white; border:none; padding:4px 10px; 
                 border-radius:4px; cursor:pointer; font-weight:bold;">
      Quit
    </button>
  </h2>



  <!-- Debug Log -->
  <div id="log">Connecting to ws://localhost:8080/ws ...</div>

  <!-- Input Area -->
  <div>
    <input id="input" type="text" value="motor temperature warning light stays on" />
    <button id="sendBtn">Send</button>
  </div>

  <!-- Answers panel -->
  <div id="answers"></div>

  <script>
    const logEl = document.getElementById("log");
    const answersEl = document.getElementById("answers");
    const ws = new WebSocket("ws://localhost:8080/ws");
    const sessions = {}; // sessionName -> DOM element

    ws.onopen = () => log("‚úÖ Connected to JarvisAgent WebSocket\n");

    ws.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);

        if (msg.type === "status") {
          updateSessionBox(msg);

        } else if (msg.type === "output") {
          showAnswer(msg);

        } else if (msg.type === "timeout") {
          showTimeout(msg);

        } else if (msg.type === "late-answer") {
          showLateAnswer(msg);

        } else {
          log("üì• Message from server:\n" + event.data + "\n");
        }

      } catch (e) {
        log("üì• " + event.data + "\n");
      }
    };

    ws.onclose = () => log("‚ùå Connection closed\n");
    ws.onerror = (err) => log("‚ö†Ô∏è Error: " + err.message + "\n");

    document.getElementById("sendBtn").onclick = () => {
      const msg = {
        type: "chat",
        subsystem: "ICE",
        message: document.getElementById("input").value
      };
      ws.send(JSON.stringify(msg));
      log("üì§ Sent: " + JSON.stringify(msg) + "\n");
    };

    // ---- Quit Button ----
    document.getElementById("quitBtn").onclick = () => {
      const msg = { type: "quit" };
      ws.send(JSON.stringify(msg));
      log("‚õî Quit requested from UI\n");
    };


    function log(text) {
      logEl.textContent += text;
      logEl.scrollTop = logEl.scrollHeight;
    }

    /* ---- Output Answer ---- */
    function showAnswer(msg) {
      const { id, text } = msg;

      const card = document.createElement("div");
      card.className = "answer-card";

      const header = document.createElement("div");
      header.className = "answer-header";
      header.textContent = `Answer for message #${id}`;

      const body = document.createElement("div");
      body.className = "answer-body";
      body.textContent = text;

      card.appendChild(header);
      card.appendChild(body);
      answersEl.prepend(card);
    }

    /* ---- Timeout ---- */
    function showTimeout(msg) {
      const { id, text } = msg;

      const card = document.createElement("div");
      card.className = "answer-card";
      card.style.border = "1px solid #c33"; // red

      card.innerHTML = `
        <div class="answer-header" style="color:#ff7777;">
          ‚ùå Timeout for message #${id}
        </div>
        <div class="answer-body" style="color:#ffb3b3;">
          ${text}
        </div>
      `;

      answersEl.prepend(card);
    }

    /* ---- Late Answer ---- */
    function showLateAnswer(msg) {
      const { id, text } = msg;

      const card = document.createElement("div");
      card.className = "answer-card";
      card.style.border = "1px solid #e0a800"; // amber

      card.innerHTML = `
        <div class="answer-header" style="color:#ffe28a;">
          ‚ö†Ô∏è Late answer for expired message #${id}
        </div>
        <div class="answer-body" style="color:#fff3cd;">
          ${text}
        </div>
      `;

      answersEl.prepend(card);
    }

    /* ---- Session Boxes ---- */
    function updateSessionBox(msg) {
      const { name, state, outputs, inflight, completed } = msg;
      let box = sessions[name];

      if (!box) {
        box = createSessionBox(name);
        sessions[name] = box;
      }

      const stateEl = box.querySelector(".session-state");
      stateEl.dataset.inflight = inflight;
      stateEl.querySelector(".state-text").textContent = state;
      stateEl.querySelector(".outputs").textContent = outputs;
      stateEl.querySelector(".inflight").textContent = inflight;
      stateEl.querySelector(".completed").textContent = completed;
    }

    function createSessionBox(name) {
      const div = document.createElement("div");
      div.className = "session-box";
      div.style.top = `${200 + Object.keys(sessions).length * 140}px`;
      div.style.left = "40px";
      div.innerHTML = `
        <div class="session-header">${name}</div>
        <div class="session-state" data-inflight="0">
          STATE: <span class="state-text">Waiting...</span>
          <span class="spinner"></span><br>
          Outputs: <span class="outputs">0</span><br>
          In flight: <span class="inflight">0</span><br>
          Completed: <span class="completed">0</span>
        </div>
      `;
      document.body.appendChild(div);
      makeDraggable(div);
      return div;
    }

    function makeDraggable(el) {
      let offsetX = 0, offsetY = 0, dragging = false;
      el.addEventListener("mousedown", (e) => {
        dragging = true;
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
        el.style.zIndex = 1000;
      });
      document.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        el.style.left = e.clientX - offsetX + "px";
        el.style.top = e.clientY - offsetY + "px";
      });
      document.addEventListener("mouseup", () => {
        dragging = false;
        el.style.zIndex = "";
      });
    }

    /* ---- Spinner ---- */
    const spinnerFrames = ["‚£æ", "‚£Ω", "‚£ª", "‚¢ø", "‚°ø", "‚£ü", "‚£Ø", "‚£∑", "‚†Å", "‚†Ç", "‚†Ñ", "‚°Ä", "‚¢Ä", "‚††", "‚†ê", "‚†à"];
    let spinIndex = 0;

    setInterval(() => {
      document.querySelectorAll(".session-state").forEach(el => {
        const inflight = parseInt(el.dataset.inflight || "0", 10);
        const spinnerEl = el.querySelector(".spinner");
        if (inflight > 0) {
          spinnerEl.textContent = spinnerFrames[spinIndex % spinnerFrames.length];
        } else {
          spinnerEl.textContent = "";
        }
      });
      spinIndex++;
    }, 100);

  </script>
</body>

</html>